# 2、IPSec协议配置与分析

## 2.1 实验目的 ##
学会配置IPSec协议。利用网络抓包软件分别对使用安全协议后的数据进行分析，从而理解安全协议的作用。

## 2.2 实验原理与理论基础 ##
IPSec（Internet Protocol Security）互联网安全协议是为IP网络提供安全性的协议和服务的集合。通信双方通过IPsec建立一条IPsec隧道，IP数据包通过IPsec隧道进行加密传输，有效保证了数据在不安全的网络环境如Internet中传输的安全性。

IPsec的工作原理大致可以分为4个阶段：

（1）识别“感兴趣流”。网络设备接收到报文后，通常会将报文的五元组等信息和IPsec策略进行匹配来判断报文是否要通过IPsec隧道传输，需要通过IPsec隧道传输的流量通常被称为“感兴趣流”。

（2）协商安全联盟（Security Association，以下简称SA）。SA是通信双方对某些协商要素的约定，比如双方使用的安全协议、数据传输采用的封装模式、协议采用的加密和验证算法、用于数据传输的密钥等，通信双方之间只有建立了SA，才能进行安全的数据传输。

（3）识别出感兴趣流后，本端网络设备会向对端网络设备发起SA协商。在这一阶段，通信双方之间通过IKE协议先协商建立IKE SA（用于身份验证和密钥信息交换），然后在IKE SA的基础上协商建立IPsec SA（用于数据安全传输）。

（4）数据传输。IPsec SA建立成功后，双方就可以通过IPsec隧道传输数据了。
IPsec为了保证数据传输的安全性，在这一阶段需要通过AH或ESP协议对数据进行加密和验证。加密机制保证了数据的机密性，防止数据在传输过程中被窃取；验证机制保证了数据的真实可靠，防止数据在传输过程中被仿冒和篡改。

如图所示，IPsec发送方会使用加密算法和加密密钥对报文进行加密，即将原始数据“乔装打扮”封装起来。然后发送方和接收方分别通过相同的验证算法和验证密钥对加密后的报文进行处理得到完整性校验值ICV。如果两端计算的ICV相同则表示该报文在传输过程中没有被篡改，接收方对验证通过的报文进行解密处理；如果ICV不相同则直接丢弃报文。

![](.\\pics\\27.png)

## 2.3 实验内容 ##

### 2.3.1 主机间直接通信

#### 两台主机网络地址分别为：

主机1：192.168.0.192
主机2：192.168.1.193

#### 配置ipsec前抓包分析
使用主机1 ping 主机2

抓包分析：主机间使用IMCP协议通信，通信内容没有加密
![](.\\pics\\28.png)

### 2.3.2 配置IPSec

![](.\\pics\\29.png)

#### ip筛选器选择本地ip（主机2：192.168.1.193）到特定ip（主1）192.168.1.192，把镜像勾选上

![](.\\pics\\30.png)

#### 身份验证方式为共享密钥（这里是使用字符3120004782）

![](.\\pics\\31.png)

#### 筛选器选择协商安全，仅保持数据完整性，不进行加密

![](.\\pics\\33.png)

#### 在另一台主机中进行以上相同的操作。

### 2.3.3不加密抓包分析（ping）

![](.\\pics\\32.png)
图中可以看到，两主机间通信使用ESP协议认证，但没有加密数据。

### 2.3.4 ESP认证加密

#### 在ipsec配置中把筛选器改为保持完整性并加密

![](.\\pics\\34.png)

### 2.3.5加密抓包分析

![](.\\pics\\35.png)
可以看到主机间的通信数据已经被加密了。